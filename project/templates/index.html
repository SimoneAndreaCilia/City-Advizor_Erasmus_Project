{% extends "base.html" %}

{% block content %}
<div class="search-container">
    <div class="hero-section">
        <h1>Discover Your Next Destination</h1>
        <p class="hero-subtitle">Find weather, attractions, and more for any city in the world.</p>

        <form method="POST" class="search-form">
            <div class="search-input-wrapper">
                <input type="text" name="city_name" placeholder="Enter city name..." class="search-input"
                    value="{{ city_name if city_name else '' }}" required>
                <button type="submit" class="btn-search">Search</button>
            </div>
        </form>

        {% if error_message %}
        <div class="error-box">
            <p class="error">{{ error_message }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Home Page Content Strategy: Visible only when not searching -->
    {% if not city_name and not weather and not error_message %}

    <!-- Features Section -->
    <div class="features-section">
        <div class="feature-item">
            <div class="feature-icon">üå§Ô∏è</div>
            <h4>Real-time Weather</h4>
            <p>Accurate forecasts for any city worldwide.</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">üó∫Ô∏è</div>
            <h4>Interactive Maps</h4>
            <p>Explore destinations with dynamic maps.</p>
        </div>
        <div class="feature-item">
            <div class="feature-icon">üèõÔ∏è</div>
            <h4>Tourist Attractions</h4>
            <p>Discover the best places to visit.</p>
        </div>
    </div>

    <!-- Popular Destinations Grid -->
    {% if popular_weather %}
    <div class="popular-section">
        <h2 class="section-title">Popular Destinations</h2>
        <div class="cards-grid popular-grid">
            {% for city in popular_weather %}
            <a href="{{ url_for('main.index', city_name=city.name) }}" class="city-card popular-card">
                <div class="popular-card-content">
                    <div class="popular-header">
                        <h3>{{ city.name }}</h3>
                        <img src="{{ city.flag_url }}" alt="Flag" class="city-flag-sm">
                    </div>
                    <div class="popular-weather">
                        <img src="{{ city.icon }}" alt="Weather Icon" class="weather-icon-sm">
                        <span class="popular-temp">{{ city.temperature }}¬∞C</span>
                    </div>
                    <p class="popular-desc">Click to explore</p>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% endif %}

    {% if weather and city_name %}
    <div class="results-container">

        <!-- City Header & Weather -->
        <div class="city-header-card">
            <div class="city-title-row">
                <div class="city-name-wrapper">
                    <h2>{{ city_name }}</h2>
                    {% if flag_url %}
                    <img src="{{ flag_url }}" alt="{{ city_name }} Flag" class="city-flag">
                    {% endif %}
                </div>

                {% if current_user.is_authenticated %}
                <form method="POST" action="{{ url_for('auth.add_favorite') }}" class="favorite-form">
                    <input type="hidden" name="city_name" value="{{ city_name }}">
                    <input type="hidden" name="country_code" value="{{ weather.country_code }}">
                    <button type="submit" class="btn-favorite {{ 'active' if is_favorite else '' }}">
                        {% if is_favorite %}
                        <span class="star-icon">‚òÖ</span> Favorited
                        {% else %}
                        <span class="star-icon">‚òÜ</span> Add to Favorites
                        {% endif %}
                    </button>
                </form>
                {% endif %}
            </div>

            <div class="weather-grid">
                <div class="weather-main">
                    <img src="{{ weather.icon }}" alt="{{ weather.conditions }}" class="weather-icon">
                    <div class="temp-wrapper">
                        <span class="temp">{{ weather.temperature }}¬∞C</span>
                        <span class="condition">{{ weather.conditions }}</span>
                    </div>
                </div>
                <div class="weather-details">
                    <div class="detail-card">
                        <span class="label">Feels Like</span>
                        <span class="value">{{ weather.feels_like }}¬∞C</span>
                    </div>
                    <div class="detail-card">
                        <span class="label">Humidity</span>
                        <span class="value">{{ weather.humidity }}%</span>
                    </div>
                    <div class="detail-card">
                        <span class="label">Wind</span>
                        <span class="value">{{ weather.wind_speed }} m/s</span>
                    </div>
                    <div class="detail-card">
                        <span class="label">Pressure</span>
                        <span class="value">{{ weather.pressure }} hPa</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Itinerary Generator -->
        <div class="city-header-card" style="margin-top: -1rem; display: flex; flex-direction: column;">
            <div class="d-flex justify-content-between align-items-center mb-3"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.5rem;">‚ú®</span>
                    <h3 style="margin: 0; color: var(--primary-color);">AI Travel Guide</h3>
                </div>
                <button id="btn-generate-itinerary" class="btn-primary" onclick="generateItinerary()"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);">
                    Generate 1-Day Itinerary
                </button>
            </div>

            <!-- Result Container -->
            <div id="ai-result-container" style="display: none; margin-top: 1rem;">
                <div class="info-card city-description"
                    style="border: 1px solid rgba(118, 75, 162, 0.3); background: rgba(118, 75, 162, 0.05);">
                    <div id="ai-spinner" style="text-align: center; padding: 2rem;">
                        <div class="spinner-custom"></div>
                        <p style="margin-top: 1rem; color: var(--text-secondary); font-weight: 500;">Creating the best
                            plan based on the weather...</p>
                    </div>
                    <div id="ai-content" style="display: none; line-height: 1.6; color: var(--text-primary);">
                        <!-- Content injected here -->
                    </div>
                </div>
            </div>

            <style>
                .spinner-custom {
                    width: 3rem;
                    height: 3rem;
                    border: 4px solid rgba(0, 0, 0, 0.1);
                    border-left-color: var(--primary-color);
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto;
                }

                @keyframes spin {
                    100% {
                        transform: rotate(360deg);
                    }
                }

                /* Dark mode adjustment for spinner track */
                body.dark-mode .spinner-custom {
                    border-color: rgba(255, 255, 255, 0.1);
                    border-left-color: var(--primary-color);
                }
            </style>
        </div>

        <!-- Quick Info Bar -->
        <div class="info-bar">
            <!-- Local Time -->
            <div class="info-bar-item">
                <span class="info-icon">üïí</span>
                <div class="info-text">
                    <span class="info-label">Local Time</span>
                    <span class="info-value" id="local-time">--:--</span>
                </div>
            </div>

            <!-- Currency (Clickable Trigger) -->
            <div class="info-bar-item clickable-info" onclick="toggleCurrencyModal()">
                <span class="info-icon">üí¥</span>
                <div class="info-text">
                    <span class="info-label">Exchange Rate</span>
                    <span class="info-value">
                        {% if exchange_rate %}
                        1 EUR ‚âà {{ exchange_rate }} {{ currency_code }}
                        {% else %}
                        Euro (EUR)
                        {% endif %}
                    </span>
                </div>
            </div>

            <!-- Emergency -->
            <div class="info-bar-item">
                <span class="info-icon">üöë</span>
                <div class="info-text">
                    <span class="info-label">Emergency</span>
                    <span class="info-value">{{ emergency_number|default('112') }}</span>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="map-container-wrapper">
            <h3>Explore {{ city_name }}</h3>
            <div id="map"></div>
        </div>

        <!-- Language Survival Guide -->
        <div id="language-guide-container" style="margin-bottom: 1.5rem;"></div>

        <!-- Info & Attractions Grid -->
        <div class="info-grid">

            {% if city_info %}
            <div class="info-card city-description">
                <h3>About {{ city_name }}</h3>
                <div class="description-content">
                    <p>{{ city_info }}</p>
                </div>
            </div>
            {% endif %}

            {% if attractions %}
            <div class="info-card attractions-list">
                <h3>Top Attractions</h3>
                <div class="attraction-cards">
                    {% for attraction in attractions %}
                    <div class="attraction-item">
                        <div class="attraction-header">
                            <h4>{{ attraction.name }}</h4>
                            {% if attraction.rating != 'N/A' %}
                            <span class="rating-badge">‚òÖ {{ attraction.rating }}</span>
                            {% endif %}
                        </div>
                        <p class="attraction-desc">{{ attraction.description }}</p>
                        <p class="attraction-address">{{ attraction.address }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

{% if weather and city_name %}

<!-- Data for JavaScript -->
<script id="city-data" type="application/json">
    {
        "name": {{ city_name | tojson }},
        "lat": {{ weather.lat | tojson }},
        "lon": {{ weather.lon | tojson }},
        "weatherConditions": {{ weather.conditions | tojson }},
        "attractions": {{ attractions | tojson if attractions else '[]' }},
        "timezoneOffset": {{ timezone_offset | default(0) }},
        "countryCode": {{ weather.country_code | tojson }}
    }
</script>

<!-- Progressive Disclosure Currency Modal -->
<div id="currency-modal-overlay" class="modal-overlay" onclick="toggleCurrencyModal()">
    <div class="custom-modal" onclick="event.stopPropagation()">
        <div class="d-flex justify-content-between align-items-center mb-4 modal-header-custom">
            <h5 class="m-0 fw-bold"><span class="modal-icon">ü™ô</span> Converter</h5>
            <button class="btn-close-custom" onclick="toggleCurrencyModal()">&times;</button>
        </div>

        <div class="converter-box position-relative">
            <!-- Amount From -->
            <div class="input-group-custom mb-3">
                <div class="currency-identity">
                    <span class="currency-flag-icon">üá™üá∫</span>
                    <span class="input-label">EUR</span>
                </div>
                <input type="number" id="amount-from" class="form-control-custom" value="1"
                    oninput="calculateCurrency()">
            </div>

            <div class="text-center my-2 swap-arrow-wrapper">
                <div class="swap-arrow">
                    <span>‚¨áÔ∏è</span>
                </div>
            </div>

            <!-- Amount To -->
            <div class="input-group-custom">
                <div class="currency-identity">
                    {% if flag_url %}
                    <img src="{{ flag_url }}" alt="Flag" class="tiny-flag">
                    {% else %}
                    <span class="currency-flag-icon">üí±</span>
                    {% endif %}
                    <span class="input-label">{{ currency_code }}</span>
                </div>
                <input type="text" id="amount-to" class="form-control-custom" readonly>
            </div>
        </div>

        <p class="text-muted small text-center mt-3 mb-0" style="opacity: 0.7;">Live rates: 1 EUR = {{ exchange_rate }}
            {{ currency_code }}</p>
    </div>
</div>

<script src="{{ url_for('static', filename='js/languages.js') }}"></script>
<script>
    // Rates from Flask
    const exchangeRate = parseFloat("{{ exchange_rate | default(1) }}");

    function toggleCurrencyModal() {
        const modal = document.getElementById('currency-modal-overlay');
        modal.classList.toggle('active');

        // Initial calculation when opening
        if (modal.classList.contains('active')) {
            calculateCurrency();
        }
    }

    function calculateCurrency() {
        const amount = document.getElementById('amount-from').value;
        const result = (amount * exchangeRate).toFixed(2);
        document.getElementById('amount-to').value = result;
    }

    // Close on Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === "Escape") {
            document.getElementById('currency-modal-overlay').classList.remove('active');
        }
    });

    // Auth status from Flask
    const isUserAuthenticated = "{{ 'true' if current_user.is_authenticated else 'false' }}" === "true";

    // AI Itinerary Logic
    function generateItinerary() {
        const btn = document.getElementById('btn-generate-itinerary');
        const container = document.getElementById('ai-result-container');
        const spinner = document.getElementById('ai-spinner');
        const content = document.getElementById('ai-content');

        // UI Updates
        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = "Generating...";
        container.style.display = 'block';
        spinner.style.display = 'block';
        content.style.display = 'none';

        // Prepare Data
        const cityData = JSON.parse(document.getElementById('city-data').textContent);
        // Extract temp securely
        let temp = "20";
        const tempEl = document.querySelector('.temp');
        if (tempEl) {
            temp = tempEl.textContent.replace('¬∞C', '').trim();
        }

        const requestData = {
            city: cityData.name,
            weather: cityData.weatherConditions,
            temp: temp
        };

        // Call API
        fetch('/api/generate-itinerary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.itinerary) {
                    // UI Magic: Split by ### and show cards
                    const rawText = data.itinerary;
                    const sections = rawText.split('###');
                    let htmlContent = '';

                    if (sections.length === 3) {
                        const times = ['üåÖ Morning', '‚òÄÔ∏è Afternoon', 'üåô Evening'];

                        htmlContent = '<div class="itinerary-grid">'; // Start Grid

                        sections.forEach((text, index) => {
                            htmlContent += `
                                <div class="itinerary-card">
                                    <h5 style="color: var(--primary-color); font-weight: 700; margin-bottom: 0.5rem; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">${times[index]}</h5>
                                    <p style="margin: 0; color: var(--text-primary); font-size: 0.95rem; line-height: 1.5;">${text.trim()}</p>
                                </div>
                            `;
                        });

                        htmlContent += '</div>'; // End Grid
                    } else {
                        // Fallback
                        htmlContent = `<div style="padding: 1rem; color: var(--text-primary);">${rawText}</div>`;
                    }

                    // ADD SAVE BUTTON HERE
                    if (isUserAuthenticated) {
                        htmlContent += `
                            <div style="margin-top: 1.5rem; text-align: right;">
                                <button onclick="saveItineraryToDB()" class="btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);">
                                    üíæ Save to Favorites
                                </button>
                            </div>
                        `;
                    } else {
                        htmlContent += `
                            <div style="margin-top: 1.5rem; text-align: center;">
                                <small><a href="{{ url_for('auth.login') }}">Login</a> to save this itinerary.</small>
                            </div>
                        `;
                    }

                    content.innerHTML = htmlContent;
                    content.style.display = 'block';
                    spinner.style.display = 'none';
                    btn.innerHTML = "Regenerate Itinerary";
                    btn.disabled = false;
                } else {
                    alert("Error generating itinerary. Please try again.");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    container.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred. Please try again.");
                btn.innerHTML = originalText;
                btn.disabled = false;
                container.style.display = 'none';
            });
    }

    function saveItineraryToDB() {
        // Get the content. We want to save the raw HTML of the grids? Or just the text?
        // Proposal says "Salviamo l'intero contenuto HTML generato".
        // Use the innerHTML of the content div, but remove the save button from it to avoid recursion if we re-display it?
        // Actually, let's just grab the current innerHTML. When displaying back, we might want to strip the button or just not show it.
        // A better approach is to reconstruct it or grab the itinerary-grid part.

        const contentDiv = document.getElementById('ai-content');
        // Clone to modify
        const clone = contentDiv.cloneNode(true);
        // Remove the save button wrapper if it exists (it's the last div usually)
        const lastDiv = clone.lastElementChild;
        if (lastDiv && lastDiv.textContent.includes('Save to Favorites')) {
            lastDiv.remove();
        }

        const htmlContent = clone.innerHTML;
        const cityData = JSON.parse(document.getElementById('city-data').textContent);

        fetch('/api/save-itinerary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                city: cityData.name,
                content: htmlContent
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    // Disable button to prevent double save
                    // document.querySelector('button[onclick="saveItineraryToDB()"]').disabled = true;
                } else {
                    alert("Error saving: " + (data.error || "Unknown error"));
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error saving itinerary.");
            });
    }

    // Existing Map/Time Logic
    document.addEventListener('DOMContentLoaded', function () {
        const cityDataElement = document.getElementById('city-data');
        if (cityDataElement) {
            const cityData = JSON.parse(cityDataElement.textContent);

            // Initialize Language Guide
            if (typeof renderLanguageGuide === 'function' && cityData.countryCode) {
                renderLanguageGuide(cityData.countryCode);
            }

            var map = L.map('map').setView([cityData.lat, cityData.lon], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            L.marker([cityData.lat, cityData.lon]).addTo(map)
                .bindPopup("<b>" + cityData.name + "</b><br>" + cityData.weatherConditions)
                .openPopup();

            if (cityData.attractions && cityData.attractions.length > 0) {
                cityData.attractions.forEach(function (attraction) {
                    L.marker([attraction.lat, attraction.lng]).addTo(map)
                        .bindPopup("<b>" + attraction.name + "</b><br>" + (attraction.address || ""));
                });
            }

            // Local Time Live Clock
            const timezoneOffset = cityData.timezoneOffset;
            function updateLocalTime() {
                const now = new Date();
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                const cityTime = new Date(utc + (1000 * timezoneOffset));
                const options = { hour: '2-digit', minute: '2-digit', hour12: false };
                document.getElementById('local-time').textContent = cityTime.toLocaleTimeString([], options);
            }
            updateLocalTime();
            setInterval(updateLocalTime, 60000);
        }
    });
</script>
{% endif %}
{% endblock %}